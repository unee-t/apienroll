# Variables needed for this script are stored on Travis Settings for this repo

  # For all environments:
    # - DOCKER_USERNAME
    # - DOCKER_PASSWORD
    # - AWS_DEFAULT_REGION

  #For dev environment:
    # - AWS_ACCOUNT_USER_ID_DEV
    # - AWS_ACCOUNT_SECRET_DEV
    # - AWS_PROFILE_DEV

  #For Demo environment:
    # - AWS_ACCOUNT_USER_ID_DEMO
    # - AWS_ACCOUNT_SECRET_DEMO
    # - AWS_PROFILE_DEMO

  #For Prod environment:
    # - AWS_ACCOUNT_USER_ID_PROD
    # - AWS_ACCOUNT_SECRET_PROD
    # - AWS_PROFILE_PROD

language: go

before_install:
- curl -sf https://up.apex.sh/install | sudo sh
- pip install --user awscli
- export PATH=$PATH:$HOME/.local/bin

services:
    - docker

install:
- go get -t ./...
- sudo apt-get install jq -y

after_success:
- test -n "$TRAVIS_TAG" && docker login -u=$"DOCKER_USERNAME" -p="$DOCKER_PASSWORD"

script:
- go test -v ./...

deploy:
 # dev
 - provider: script
    script: TRAVIS_PROFILE=$AWS_PROFILE_DEV TRAVIS_AWS_ACCESS_KEY_ID=$AWS_ACCOUNT_USER_ID_DEV TRAVIS_AWS_SECRET_ACCESS_KEY=$AWS_ACCOUNT_SECRET_DEV TRAVIS_AWS_DEFAULT_REGION=$AWS_DEFAULT_REGION ./deploy.sh dev
    edge: true
    on:
      branch: master

 # demo
 - provider: script
    script: TRAVIS_PROFILE=$AWS_PROFILE_DEMO TRAVIS_AWS_ACCESS_KEY_ID=$AWS_ACCOUNT_USER_ID_DEMO TRAVIS_AWS_SECRET_ACCESS_KEY=$AWS_ACCOUNT_SECRET_DEMO TRAVIS_AWS_DEFAULT_REGION=$AWS_DEFAULT_REGION ./deploy.sh demo
    edge: true
    on:
      tags: true
      branch: master

 # production
 - provider: script
    script: TRAVIS_PROFILE=$AWS_PROFILE_PROD TRAVIS_AWS_ACCESS_KEY_ID=$AWS_ACCOUNT_USER_ID_PROD TRAVIS_AWS_SECRET_ACCESS_KEY=$AWS_ACCOUNT_SECRET_PROD TRAVIS_AWS_DEFAULT_REGION=$AWS_DEFAULT_REGION ./deploy.sh prod
    edge: true
    on:
      tags: true
      branch: master
 - provider: script
    edge: true
    script: curl -sL https://git.io/goreleaser | bash
    on:
     tags: true
     condition: $TRAVIS_OS_NAME = linux

env:
  - GO111MODULE=on
